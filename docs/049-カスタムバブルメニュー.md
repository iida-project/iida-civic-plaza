# 049 カスタムバブルメニュー（テキスト選択時）

## 概要
Tiptapエディタでテキスト選択時に表示されるバブルメニューを、
React Portal + Floating UIで自作実装する。

## 関連要件
- RichTextEditorの機能拡張
- テキスト選択時のインライン書式設定

## 背景・問題点
Tiptap 3.xの組み込み `BubbleMenu` には以下の問題がある：
- サイドバーなどの要素の後ろに隠れる（z-index問題）
- 画面端で切れる
- `tippyOptions` が廃止され Floating UI に変更されたが、`options` プロパティが期待通り動作しない

## 解決策
React Portal + Floating UI でカスタム実装

## 技術仕様

### 必要パッケージ
```bash
npm install @floating-ui/react-dom
```

### ファイル構成
```
src/components/admin/editor/
├── RichTextEditor.tsx      # 既存（ここに統合）
├── EditorToolbar.tsx       # 既存
└── CustomBubbleMenu.tsx    # 新規作成
```

### 表示条件
- テキストが選択されているとき
- 選択範囲が空でないとき

### メニュー機能
- 太字（Bold）
- 斜体（Italic）
- 取り消し線（Strike）
- リンク設定
- コード（inline code）

## 実装コード

```tsx
// CustomBubbleMenu.tsx
'use client'

import { useState, useEffect, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { Editor } from '@tiptap/react'
import {
  useFloating,
  offset,
  flip,
  shift,
  autoUpdate,
} from '@floating-ui/react-dom'

interface CustomBubbleMenuProps {
  editor: Editor
  children: React.ReactNode
}

export function CustomBubbleMenu({ editor, children }: CustomBubbleMenuProps) {
  const [isVisible, setIsVisible] = useState(false)
  const [mounted, setMounted] = useState(false)

  const { refs, floatingStyles } = useFloating({
    placement: 'top',
    middleware: [
      offset(8),
      flip({ padding: 8 }),
      shift({ padding: 8 }),
    ],
    whileElementsMounted: autoUpdate,
  })

  const updateMenu = useCallback(() => {
    if (!editor) return

    const { selection } = editor.state
    const { empty } = selection

    if (empty) {
      setIsVisible(false)
      return
    }

    const { from, to } = selection
    const start = editor.view.coordsAtPos(from)
    const end = editor.view.coordsAtPos(to)

    const virtualEl = {
      getBoundingClientRect() {
        return {
          x: start.left,
          y: start.top,
          top: start.top,
          left: start.left,
          bottom: end.bottom,
          right: end.right,
          width: end.right - start.left,
          height: end.bottom - start.top,
        }
      },
    }

    refs.setReference(virtualEl)
    setIsVisible(true)
  }, [editor, refs])

  useEffect(() => {
    if (!editor) return
    editor.on('selectionUpdate', updateMenu)
    editor.on('transaction', updateMenu)
    return () => {
      editor.off('selectionUpdate', updateMenu)
      editor.off('transaction', updateMenu)
    }
  }, [editor, updateMenu])

  useEffect(() => {
    setMounted(true)
  }, [])

  if (!mounted || !isVisible) return null

  return createPortal(
    <div
      ref={refs.setFloating}
      style={{
        ...floatingStyles,
        zIndex: 9999,
      }}
      className="flex items-center gap-0.5 p-1 rounded-lg shadow-lg border bg-white"
    >
      {children}
    </div>,
    document.body
  )
}
```

## Todo
- [ ] @floating-ui/react-dom パッケージインストール
- [ ] CustomBubbleMenu.tsx 作成
- [ ] RichTextEditor.tsx に統合
- [ ] ツールバーボタン（Bold, Italic, Strike, Link, Code）実装

## 完了条件
- テキスト選択時にバブルメニューが表示される
- メニューがサイドバーより前面に表示される
- 画面端でも切れずに表示される
- インライン書式が適用できる

## 備考
- `createPortal` で `document.body` に直接レンダリング
- `z-index: 9999` でサイドバーより前面に
- `shift({ padding: 8 })` で画面端から8px確保
- `flip({ padding: 8 })` で上に空きがなければ下に反転
