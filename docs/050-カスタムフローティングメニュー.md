# 050 カスタムフローティングメニュー（空行・ブロック先頭時）

## 概要
Tiptapエディタで空行やブロックの先頭にカーソルがあるとき表示される
フローティングメニューを、React Portal + Floating UIで自作実装する。

## 関連要件
- RichTextEditorの機能拡張
- ブロック要素の挿入（画像、水平線、見出し等）

## 背景
BubbleMenuと同様、Tiptap 3.xの組み込み `FloatingMenu` にもz-index問題がある。
同じアプローチでカスタム実装する。

## 技術仕様

### ファイル構成
```
src/components/admin/editor/
├── RichTextEditor.tsx        # 既存（ここに統合）
├── EditorToolbar.tsx         # 既存
├── CustomBubbleMenu.tsx      # 048で作成
└── CustomFloatingMenu.tsx    # 新規作成
```

### 表示条件
- カーソルが空のブロック（段落）にあるとき
- カーソルがブロックの先頭にあるとき
- テキスト選択時は非表示（BubbleMenuと競合しないように）

### メニュー機能
- 画像挿入
- 水平線
- 見出し（H1, H2, H3）
- 引用
- リスト（箇条書き、番号付き）

## 実装コード

```tsx
// CustomFloatingMenu.tsx
'use client'

import { useState, useEffect, useCallback } from 'react'
import { createPortal } from 'react-dom'
import { Editor } from '@tiptap/react'
import {
  useFloating,
  offset,
  flip,
  shift,
  autoUpdate,
} from '@floating-ui/react-dom'

interface CustomFloatingMenuProps {
  editor: Editor
  children: React.ReactNode
}

export function CustomFloatingMenu({ editor, children }: CustomFloatingMenuProps) {
  const [isVisible, setIsVisible] = useState(false)
  const [mounted, setMounted] = useState(false)

  const { refs, floatingStyles } = useFloating({
    placement: 'left-start',
    middleware: [
      offset(8),
      flip({ padding: 8 }),
      shift({ padding: 8 }),
    ],
    whileElementsMounted: autoUpdate,
  })

  const updateMenu = useCallback(() => {
    if (!editor) return

    const { selection } = editor.state
    const { $anchor, empty } = selection

    // テキスト選択時は非表示
    if (!empty) {
      setIsVisible(false)
      return
    }

    // 空ブロックまたはブロック先頭かチェック
    const isEmptyBlock = $anchor.parent.content.size === 0
    const isAtStart = $anchor.parentOffset === 0

    if (!isEmptyBlock && !isAtStart) {
      setIsVisible(false)
      return
    }

    const coords = editor.view.coordsAtPos(selection.from)

    const virtualEl = {
      getBoundingClientRect() {
        return {
          x: coords.left,
          y: coords.top,
          top: coords.top,
          left: coords.left,
          bottom: coords.bottom,
          right: coords.left,
          width: 0,
          height: coords.bottom - coords.top,
        }
      },
    }

    refs.setReference(virtualEl)
    setIsVisible(true)
  }, [editor, refs])

  useEffect(() => {
    if (!editor) return
    editor.on('selectionUpdate', updateMenu)
    editor.on('transaction', updateMenu)
    return () => {
      editor.off('selectionUpdate', updateMenu)
      editor.off('transaction', updateMenu)
    }
  }, [editor, updateMenu])

  useEffect(() => {
    setMounted(true)
  }, [])

  if (!mounted || !isVisible) return null

  return createPortal(
    <div
      ref={refs.setFloating}
      style={{
        ...floatingStyles,
        zIndex: 9999,
      }}
      className="flex items-center gap-0.5 p-1 rounded-lg shadow-lg border bg-white"
    >
      {children}
    </div>,
    document.body
  )
}
```

## Todo
- [ ] CustomFloatingMenu.tsx 作成
- [ ] RichTextEditor.tsx に統合
- [ ] ツールボタン（画像、水平線、H1/H2/H3、引用、リスト）実装
- [ ] 画像挿入時はonImageUploadコールバック使用

## 完了条件
- 空行やブロック先頭でフローティングメニューが表示される
- テキスト選択時は非表示（BubbleMenuと競合しない）
- メニューがサイドバーより前面に表示される
- 各種ブロック要素を挿入できる

## 備考
- BubbleMenuとFloatingMenuは同時に使用可能（競合しない）
- BubbleMenu: テキスト選択時に表示
- FloatingMenu: 空行・ブロック先頭で表示
